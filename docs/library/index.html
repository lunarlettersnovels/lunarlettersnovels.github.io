<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>My Library - Lunar Letters</title>
    <meta name="description" content="Read novels online at Lunar Letters">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/main.css">
    <script src="/assets/main.js" defer></script>
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>

<body>
    <div class="app-shell">
        
        <header class="app-header" id="app-header">
            <div class="app-header-inner">
                <a href="/" class="app-logo">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
                            fill="currentColor" />
                    </svg>
                    <span>Lunar Letters</span>
                </a>
                <nav class="desktop-nav">
                    <a href="/" class="nav-link active">Home</a>
                    <a href="/library" class="nav-link">Library</a>
                </nav>
                <div class="app-header-actions">
                    <button id="theme-toggle" class="app-icon-btn" aria-label="Toggle theme">
                        <svg class="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" height="22"
                            viewBox="0 -960 960 960" width="22" fill="currentColor">
                            <path
                                d="M440-760v-160h80v160h-80Zm266 110-55-55 112-115 56 57-113 113Zm54 210v-80h160v80H760ZM440-40v-160h80v160h-80ZM254-652 140-763l56-56 113 113-55 54Zm-94 292v-80h160v80H160Zm114 268 54-55 115 112-57 57-112-114ZM480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280Z" />
                        </svg>
                        <svg class="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" height="22"
                            viewBox="0 -960 960 960" width="22" fill="currentColor">
                            <path
                                d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        
        <main class="app-content">
            
<div class="library-page">
    <div class="library-header">
        <h1 class="library-title">My Library</h1>
    </div>

    
    <div class="lib-tabs" id="lib-tabs">
        <button class="lib-tab active" data-tab="bookmarks">Bookmarks</button>
        <button class="lib-tab" data-tab="history">History</button>
    </div>

    
    <div class="lib-panel active" id="lib-panel-bookmarks">
        <div class="lib-empty" id="bookmarks-empty">
            <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48" fill="currentColor">
                <path d="M200-120v-640q0-33 23.5-56.5T280-840h400q33 0 56.5 23.5T760-760v640L480-240 200-120Z" />
            </svg>
            <p>No bookmarks yet</p>
            <span>Bookmark novels from the homepage to see them here</span>
        </div>
        <div class="lib-list" id="bookmarks-list"></div>
    </div>

    
    <div class="lib-panel" id="lib-panel-history">
        <div class="lib-empty" id="history-empty">
            <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48" fill="currentColor">
                <path
                    d="M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z" />
            </svg>
            <p>No reading history</p>
            <span>Chapters you read will appear here</span>
        </div>
        <div class="lib-list" id="history-list"></div>
    </div>

    
    <div class="lib-data-section">
        <h3 class="lib-data-title">Data Management</h3>
        <div class="lib-data-actions">
            <button class="lib-data-btn" id="export-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"
                    fill="currentColor">
                    <path
                        d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                </svg>
                Export Data
            </button>
            <button class="lib-data-btn" id="import-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"
                    fill="currentColor">
                    <path
                        d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
                </svg>
                Import Data
            </button>
            <button class="lib-data-btn danger" id="clear-btn">
                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"
                    fill="currentColor">
                    <path
                        d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T700-120H280Z" />
                </svg>
                Clear All Data
            </button>
        </div>
        <input type="file" id="import-file" accept=".json" style="display:none">
    </div>
</div>

<script>
    (function () {
        
        const DB_NAME = 'LunarLettersDB';
        const DB_VERSION = 1;
        let db = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = (e) => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('bookmarks')) {
                        const bStore = d.createObjectStore('bookmarks', { keyPath: 'slug' });
                        bStore.createIndex('addedAt', 'addedAt', { unique: false });
                    }
                    if (!d.objectStoreNames.contains('history')) {
                        const hStore = d.createObjectStore('history', { keyPath: 'id' });
                        hStore.createIndex('readAt', 'readAt', { unique: false });
                        hStore.createIndex('seriesSlug', 'seriesSlug', { unique: false });
                    }
                    if (!d.objectStoreNames.contains('progress')) {
                        d.createObjectStore('progress', { keyPath: 'seriesId' });
                    }
                };
                req.onsuccess = (e) => { db = e.target.result; resolve(db); };
                req.onerror = (e) => reject(e.target.error);
            });
        }

        function getAll(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                const req = store.clear();
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        function putAll(storeName, items) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                items.forEach(item => store.put(item));
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        
        async function migrateLocalStorage() {
            const raw = localStorage.getItem('reading_progress');
            if (!raw) return;

            try {
                const progress = JSON.parse(raw);
                const tx = db.transaction('progress', 'readwrite');
                const store = tx.objectStore('progress');

                for (const [seriesId, chapterIds] of Object.entries(progress)) {
                    store.put({ seriesId: parseInt(seriesId), chapters: chapterIds });
                }

                await new Promise((resolve, reject) => {
                    tx.oncomplete = resolve;
                    tx.onerror = () => reject(tx.error);
                });

                
            } catch (e) {
                console.warn('Migration failed:', e);
            }
        }

        
        function renderBookmarks(bookmarks) {
            const list = document.getElementById('bookmarks-list');
            const empty = document.getElementById('bookmarks-empty');
            if (!list || !empty) return;

            if (bookmarks.length === 0) {
                empty.style.display = '';
                list.innerHTML = '';
                return;
            }

            empty.style.display = 'none';
            list.innerHTML = bookmarks
                .sort((a, b) => (b.addedAt || 0) - (a.addedAt || 0))
                .map(bm => `
                <a href="/novel/${bm.slug}" class="lib-row">
                    <div class="lib-row-info">
                        <div class="lib-row-title">${escHtml(bm.title)}</div>
                        <div class="lib-row-meta">${bm.author ? escHtml(bm.author) : 'Unknown Author'}</div>
                    </div>
                    <button class="lib-row-action" data-action="remove-bookmark" data-slug="${bm.slug}" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor">
                            <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                        </svg>
                    </button>
                </a>
            `).join('');

            
            list.querySelectorAll('[data-action="remove-bookmark"]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const slug = btn.dataset.slug;
                    const tx = db.transaction('bookmarks', 'readwrite');
                    tx.objectStore('bookmarks').delete(slug);
                    await new Promise(r => { tx.oncomplete = r; });
                    const updated = await getAll('bookmarks');
                    renderBookmarks(updated);
                });
            });
        }

        function renderHistory(history) {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');
            if (!list || !empty) return;

            if (history.length === 0) {
                empty.style.display = '';
                list.innerHTML = '';
                return;
            }

            empty.style.display = 'none';
            
            const grouped = {};
            history.forEach(h => {
                if (!grouped[h.seriesSlug]) {
                    grouped[h.seriesSlug] = { title: h.seriesTitle, slug: h.seriesSlug, chapters: [] };
                }
                grouped[h.seriesSlug].chapters.push(h);
            });

            const groups = Object.values(grouped).sort((a, b) => {
                const latestA = Math.max(...a.chapters.map(c => c.readAt || 0));
                const latestB = Math.max(...b.chapters.map(c => c.readAt || 0));
                return latestB - latestA;
            });

            list.innerHTML = groups.map(g => {
                const latestCh = g.chapters.sort((a, b) => (b.readAt || 0) - (a.readAt || 0))[0];
                const timeAgo = formatTimeAgo(latestCh.readAt);
                return `
                <a href="/novel/${g.slug}" class="lib-row">
                    <div class="lib-row-info">
                        <div class="lib-row-title">${escHtml(g.title)}</div>
                        <div class="lib-row-meta">${g.chapters.length} chapter${g.chapters.length > 1 ? 's' : ''} read Â· ${timeAgo}</div>
                    </div>
                    <svg class="lib-row-chevron" xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="currentColor">
                        <path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"/>
                    </svg>
                </a>
            `;
            }).join('');
        }

        function escHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function formatTimeAgo(ts) {
            if (!ts) return 'Unknown';
            const diff = Date.now() - ts;
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + 'm ago';
            const hours = Math.floor(mins / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            if (days < 30) return days + 'd ago';
            return new Date(ts).toLocaleDateString();
        }

        
        async function exportData() {
            const bookmarks = await getAll('bookmarks');
            const history = await getAll('history');
            const progress = await getAll('progress');
            const data = { version: 1, exportedAt: new Date().toISOString(), bookmarks, history, progress };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lunarletters-library-' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importData(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                if (data.bookmarks) await putAll('bookmarks', data.bookmarks);
                if (data.history) await putAll('history', data.history);
                if (data.progress) {
                    await putAll('progress', data.progress);
                    
                    const allProgress = await getAll('progress');
                    const lsObj = {};
                    allProgress.forEach(p => { lsObj[p.seriesId] = p.chapters; });
                    localStorage.setItem('reading_progress', JSON.stringify(lsObj));
                }
                alert('Data imported successfully!');
                location.reload();
            } catch (e) {
                alert('Failed to import: ' + e.message);
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure? This will delete all your bookmarks, reading history, and progress.')) return;
            await clearStore('bookmarks');
            await clearStore('history');
            await clearStore('progress');
            localStorage.removeItem('reading_progress');
            alert('All data cleared.');
            location.reload();
        }

        
        document.addEventListener('DOMContentLoaded', async () => {
            await openDB();
            await migrateLocalStorage();

            
            document.querySelectorAll('.lib-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.lib-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.lib-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('lib-panel-' + tab.dataset.tab).classList.add('active');
                });
            });

            
            const bookmarks = await getAll('bookmarks');
            renderBookmarks(bookmarks);

            const history = await getAll('history');
            renderHistory(history);

            
            document.getElementById('export-btn').addEventListener('click', exportData);

            
            const importFile = document.getElementById('import-file');
            document.getElementById('import-btn').addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => {
                if (e.target.files[0]) importData(e.target.files[0]);
            });

            
            document.getElementById('clear-btn').addEventListener('click', clearAllData);
        });
    })();
</script>

        </main>

        
        <nav class="bottom-bar">
            <a href="/" class="tab-item active">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                    fill="currentColor">
                    <path
                        d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Z" />
                </svg>
                <span>Home</span>
            </a>
            <a href="/library" class="tab-item">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
                    fill="currentColor">
                    <path d="M200-120v-640q0-33 23.5-56.5T280-840h400q33 0 56.5 23.5T760-760v640L480-240 200-120Z" />
                </svg>
                <span>Library</span>
            </a>
        </nav>
    </div>
</body>

</html>